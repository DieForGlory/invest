{% extends "layouts/base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ _('Аналитика по менеджерам') }}</h1>
</div>

{# --- ВКЛАДКИ --- #}
<ul class="nav nav-tabs mb-4">
    <li class="nav-item">
        <a class="nav-link {% if active_tab == 'general' %}active{% endif %}" href="{{ url_for('manager_analytics.show_report') }}">{{ _('Общий отчет') }}</a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if active_tab == 'yearly' %}active{% endif %}" href="{{ url_for('manager_analytics.yearly_report') }}">{{ _('Годовой отчет по менеджеру') }}</a>
    </li>
</ul>

<div class="card card-glass mb-4">
    <div class="card-body">
        <form method="GET" action="{{ url_for('manager_analytics.yearly_report') }}">
            <div class="row g-3 align-items-end">
                <div class="col-md-6">
                    <label for="manager-select" class="form-label">{{ _('Выберите менеджера') }}</label>
                    <select name="manager_id" id="manager-select" class="form-select" required>
                        <option value="">{{ _('-- Менеджер --') }}</option>
                        {% for manager in all_managers %}
                            <option value="{{ manager.id }}" {% if manager.id == selected_manager_id %}selected{% endif %}>{{ manager.full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="year-select" class="form-label">{{ _('Год') }}</label>
                    <select name="year" id="year-select" class="form-select">
                        {% for y in years %}
                            <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100">{{ _('Показать') }}</button>
                </div>
            </div>
        </form>
    </div>
</div>

{% if report_data %}
<div class="card card-glass mb-4">
    <div class="card-header">
        <h4>{{ _('График показателей:') }} {{ selected_manager.full_name }} ({{ selected_year }} {{ _('г.') }})</h4>
    </div>
    <div class="card-body">
        <canvas id="managerYearlyChart"></canvas>
    </div>
</div>

<div class="card card-glass">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>{{ _('Месяц') }}</th>
                        <th class="text-center">{{ _('Бронь') }}</th>
                        <th class="text-center">{{ _('Сделка в работе') }}</th>
                        <th class="text-center">{{ _('Сделка проведена') }}</th>
                        <th class="text-center">{{ _('Отказы / Отмены') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for month_data in report_data %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td class="text-center">{{ month_data.bookings.count }}</td>
                        <td class="text-center">{{ month_data.deals_in_progress.count }}</td>
                        <td class="text-center">{{ month_data.deals_completed.count }}</td>
                        <td class="text-center text-danger">{{ month_data.deals_failed.count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="table-light fw-bold">
                        <td>{{ _('Итого за год') }}</td>
                        <td class="text-center">{{ annual_totals.bookings }}</td>
                        <td class="text-center">{{ annual_totals.deals_in_progress }}</td>
                        <td class="text-center">{{ annual_totals.deals_completed }}</td>
                        <td class="text-center">{{ annual_totals.deals_failed }}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    {% if report_data %}

    // Передаем переводы в JavaScript
    window.i18n = {
        months: [
            "{{ _('Янв') }}", "{{ _('Фев') }}", "{{ _('Мар') }}", "{{ _('Апр') }}",
            "{{ _('Май') }}", "{{ _('Июн') }}", "{{ _('Июл') }}", "{{ _('Авг') }}",
            "{{ _('Сен') }}", "{{ _('Окт') }}", "{{ _('Ноя') }}", "{{ _('Дек') }}"
        ],
        bookings: "{{ _('Бронь') }}",
        deals_in_progress: "{{ _('Сделка в работе') }}",
        deals_completed: "{{ _('Сделка проведена') }}"
    };

    const ctx = document.getElementById('managerYearlyChart').getContext('2d');
    const monthlyData = {{ report_data|tojson }};

    // Используем переводы
    const labels = window.i18n.months;

    const datasets = [
        {
            label: window.i18n.bookings,
            data: monthlyData.map(d => d.bookings.count),
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        },
        {
            label: window.i18n.deals_in_progress,
            data: monthlyData.map(d => d.deals_in_progress.count),
            backgroundColor: 'rgba(255, 206, 86, 0.6)',
            borderColor: 'rgba(255, 206, 86, 1)',
            borderWidth: 1
        },
        {
            label: window.i18n.deals_completed,
            data: monthlyData.map(d => d.deals_completed.count),
            backgroundColor: 'rgba(75, 192, 192, 0.6)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
        }
    ];

    const config = {
        type: 'bar',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    };

    new Chart(ctx, config);
    {% endif %}
});
</script>
{% endblock %}