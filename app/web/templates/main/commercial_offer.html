<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ _('Коммерческое предложение по объекту ID:') }} {{ data.apartment.id }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #fff;
            font-size: 9pt;
            color: #1a1a1a;
        }
        .page-container {
            width: 210mm;
            min-height: 297mm;
            padding: 10mm;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
        }
        .header {
            text-align: center;
            margin-bottom: 0.5rem;
            padding-bottom: 0;
            position: relative;
        }
        .section-title {
            font-size: 12pt;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #c4a668;
            padding-bottom: 0.4rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }
        .header-logo {
            position: absolute;
            top: 0;
            left: 0;
            height: 34px;
            width: auto;
        }
        .header h1 {
            color: #c4a668;
            font-weight: 700;
            font-size: 18pt;
            margin: 0;
        }
        .header p {
            font-size: 8.5pt;
            color: #555;
            margin-top: 0.2rem;
        }
        .info-block {
            background-color: #fcfcfc;
            border: 1px solid #eee;
            border-radius: 0.4rem;
            padding: 0.75rem 1rem;
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding: 0.5rem 0.2rem;
            border-bottom: 1px solid #f0f0f0;
        }
        .info-item:last-child {
            border-bottom: none;
        }
        .info-label {
            font-weight: 500;
            color: #666;
            font-size: 9pt;
        }
        .info-value {
            font-weight: 600;
            color: #212529;
            font-size: 10pt;
        }
        .row > .col-6 {
            display: flex;
            align-items: stretch;
        }
        .payment-option-block {
            border: 1px solid #ddd;
            border-radius: 0.4rem;
            width: 100%;
            display: flex;
            flex-direction: column;
            background-color: #fff;
        }
        .payment-option-block.full_payment,
        .payment-option-block.easy_start_100 {
            border-left: 4px solid #c4a668;
        }
        .payment-option-block.mortgage,
        .payment-option-block.easy_start_mortgage {
            border-left: 4px solid #0d6efd;
        }
        .payment-option-block h3 {
            font-size: 11pt;
            font-weight: 600;
            margin: 0;
            padding: 0.6rem 1rem;
            border-bottom: 1px solid #ddd;
        }
        .payment-option-block.full_payment h3,
        .payment-option-block.easy_start_100 h3 {
            background-color: #fffaf0;
            color: #a87d44;
        }
        .payment-option-block.mortgage h3,
        .payment-option-block.easy_start_mortgage h3 {
            background-color: #f0f7ff;
            color: #0056b3;
        }
        .card-content {
            padding: 0.75rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .price-summary {
            text-align: center;
            padding-top: 0.5rem;
            margin-top: auto;
            border-top: 1px dashed #ccc;
        }
        .payment-details-table {
            font-size: 8.5pt;
        }
        .payment-details-table td {
            padding: 0.25rem 0.2rem;
        }
        .payment-details-table .price-per-sqm-row td {
            padding-top: 0.4rem;
            border-top: 1px solid #eee;
            font-weight: 600;
        }
        .summary-label {
            font-size: 8pt;
            text-transform: uppercase;
            color: #777;
            margin-bottom: 0.1rem;
        }
        .summary-value {
            font-size: 16pt;
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
        }
        .summary-value.gold {
            background: linear-gradient(to right, #DAA520, #B8860B);
            -webkit-background-clip: text;
            color: transparent;
        }
        .summary-value.blue { color: #0d6efd; }
        .footer {
            text-align: center;
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid #ccc;
            font-size: 8pt;
            color: #888;
        }
        @media print {
            body { margin: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            .page-container { min-height: 0; box-shadow: none; border: none; }
            .hide-for-print { display: none !important; }
        }
    </style>
</head>
<body>
    <div class="page-container shadow-lg">
        <div class="no-print d-flex justify-content-between mb-3">
            <div class="form-check form-switch fs-5">
                <input class="form-check-input" type="checkbox" id="currencySwitch">
                <label class="form-check-label text-muted" for="currencySwitch" style="font-size: 1rem;">{{ _('Показать в USD') }}</label>
            </div>
            <button class="btn btn-secondary" type="button" data-bs-toggle="modal" data-bs-target="#printChoiceModal">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-printer-fill" viewBox="0 0 16 16"><path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4zM12 7H4a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V8a1 1 0 0 0-1-1m-1 4H5a.5.5 0 0 1 0-1h6a.5.5 0 0 1 0 1m-1-2H6a.5.5 0 0 1 0-1h4a.5.5 0 0 1 0 1"/></svg>
                {{ _('Печать') }}
            </button>
        </div>
        <div class="header">
            <img src="{{ url_for('static', filename='logo_light.svg') }}" alt="{{ _('Логотип') }}" class="header-logo">
            <h1>{{ _('Коммерческое предложение') }}</h1>
            <p><strong>Golden House | {{ _('Жилая недвижимость') }}. {{ _('Дата') }}: {{ current_date }}</strong></p>
        </div>

        <div class="section-title">1. {{ _('Информация об объекте') }}</div>
        <div class="info-block">
            <div class="info-item"><span class="info-label">{{ _('Жилой комплекс:') }}</span><span class="info-value">{{ data.apartment.house.complex_name if data.apartment.house else 'N/A' }}</span></div>
            <div class="info-item"><span class="info-label">{{ _('Номер дома:') }}</span><span class="info-value">{{ data.apartment.house.geo_house if data.apartment.house else 'N/A' }}</span></div>
            <div class="info-item"><span class="info-label">{{ _('Тип/Этаж/Комнат:') }}</span><span class="info-value">{{ data.apartment.estate_sell_category }} / {{ data.apartment.estate_floor }} / {{ data.apartment.estate_rooms }}</span></div>
            <div class="info-item"><span class="info-label">{{ _('Общая площадь:') }}</span><span class="info-value">{{ data.apartment.estate_area }} м²</span></div>
            <div class="info-item"><span class="info-label">{{ _('Цена за м² (Прайс):') }}</span><span class="info-value price-uzs" data-price="{{ data.apartment.estate_price_m2 }}">{{ "{:,.0f}".format(data.apartment.estate_price_m2) }} UZS</span></div>
            <div class="info-item"><span class="info-label">{{ _('Прайс:') }}</span><span class="info-value price-uzs" data-price="{{ data.apartment.estate_price }}">{{ "{:,.0f}".format(data.apartment.estate_price) }} UZS</span></div>
        </div>

        <div class="section-title">2. {{ _('Предлагаемые варианты оплаты') }}</div>
        {% if data.pricing %}
            <div class="row {% if data.pricing|length == 1 %}justify-content-center{% endif %}">
            {% for option in data.pricing %}
                {% set col_class = 'col-8' if data.pricing|length == 1 else 'col-6' %}
                <div class="{{ col_class }} mb-4 payment-block" data-type-key="{{ option.type_key }}">
                <div class="payment-option-block {{ option.type_key }}">
                        <h3>{{ option.payment_method }}</h3>
                        <div class="card-content">
                            <div>
                                <table class="table table-sm table-borderless payment-details-table">
                                    <tbody>
                                        <tr><td>{{ _('Прайс:') }}</td><td class="text-end price-uzs" data-price="{{ option.base_price }}">{{ "{:,.0f}".format(option.base_price) }} UZS</td></tr>
                                        <tr class="text-danger"><td>{{ _('Вычет (бронирование):') }}</td><td class="text-end price-uzs" data-price="{{ option.deduction }}">- {{ "{:,.0f}".format(option.deduction) }} UZS</td></tr>
                                        {% set total_benefit = (option.applied_discounts|sum(attribute='amount')) %}
                                        {% if total_benefit > 0 %}
                                        <tr class="text-danger">
                                            <td>{{ _('Выгода:') }}</td>
                                            <td class="text-end price-uzs" data-price="{{ total_benefit }}">- {{ "{:,.0f}".format(total_benefit) }} UZS</td>
                                        </tr>
                                        {% endif %}
                                        {% if data.apartment.estate_area and data.apartment.estate_area > 0 %}
                                            {% set price_per_sqm = option.final_price / data.apartment.estate_area %}
                                            <tr class="price-per-sqm-row">
                                                <td>{{ _('Цена за м² (со скидкой):') }}</td>
                                                <td class="text-end price-uzs" data-price="{{ price_per_sqm }}">{{ "{:,.0f}".format(price_per_sqm) }} UZS</td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                            <div class="price-summary">
                                {% if option.type_key == 'easy_start_100' %}
                                    <p class="summary-label">{{ _('3 платежа по:') }}</p>
                                    <p class="summary-value gold price-uzs" data-price="{{ option.final_price / 3 }}">{{ "{:,.0f}".format(option.final_price / 3) }} UZS</p>
                                    <p class="summary-label mt-2">{{ _('Итоговая стоимость:') }}</p>
                                    <p class="summary-value gold price-uzs" data-price="{{ option.final_price }}">{{ "{:,.0f}".format(option.final_price) }} UZS</p>
                                {% elif option.type_key == 'easy_start_mortgage' %}
                                    <p class="summary-label">{{ _('Первоначальный взнос (3 платежа по):') }}</p>
                                    <p class="summary-value blue price-uzs" data-price="{{ option.initial_payment / 3 }}">{{ "{:,.0f}".format(option.initial_payment / 3) }} UZS</p>
                                    <p class="summary-label mt-2">{{ _('Итоговая стоимость:') }}</p>
                                    <p class="summary-value gold price-uzs" data-price="{{ option.final_price }}">{{ "{:,.0f}".format(option.final_price) }} UZS</p>
                                {% elif option.initial_payment is not none %}
                                    <p class="summary-label">{{ _('Первоначальный взнос:') }}</p>
                                    <p class="summary-value blue price-uzs" data-price="{{ option.initial_payment }}">{{ "{:,.0f}".format(option.initial_payment) }} UZS</p>
                                    <p class="summary-label mt-2">{{ _('Итоговая стоимость:') }}</p>
                                    <p class="summary-value gold price-uzs" data-price="{{ option.final_price }}">{{ "{:,.0f}".format(option.final_price) }} UZS</p>
                                {% else %}
                                    <p class="summary-label">{{ _('Итоговая стоимость:') }}</p>
                                    <p class="summary-value gold price-uzs" data-price="{{ option.final_price }}">{{ "{:,.0f}".format(option.final_price) }} UZS</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-warning">{{ _('Не удалось рассчитать варианты оплаты.') }}</div>
        {% endif %}

        <div class="footer">
            <p>{% trans %}Это коммерческое предложение не является публичной офертой. Актуальность цен и условий уточняйте у менеджеров Golden House.{% endtrans %}</p>
        </div>
    </div>

    <div class="modal fade" id="printChoiceModal" tabindex="-1" aria-labelledby="printChoiceModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="printChoiceModalLabel">{{ _('Выберите вариант печати') }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>{{ _('Какой набор опций вы хотите включить в печатную версию?') }}</p>
            <div class="d-grid gap-2">
                <button type="button" class="btn btn-primary" id="printVariant1Btn">{{ _('Вариант 1 (только 100%% и Ипотека)') }}</button>
                <button type="button" class="btn btn-secondary" id="printComboBtn">{{ _('Вариант Комбо (Все опции)') }}</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const USD_TO_UZS_RATE = {{ usd_to_uzs_rate }};
            const currencySwitch = document.getElementById('currencySwitch');
            if (currencySwitch) {
                currencySwitch.addEventListener('change', () => {
                    const isUsd = currencySwitch.checked;
                    document.querySelectorAll('.price-uzs').forEach(el => {
                        const uzsValue = parseFloat(el.dataset.price);
                        if (isNaN(uzsValue)) return;
                        if (isUsd) {
                            el.textContent = '$' + (uzsValue / USD_TO_UZS_RATE).toLocaleString('en-US', {maximumFractionDigits: 0});
                        } else {
                            el.textContent = uzsValue.toLocaleString('ru-RU', {maximumFractionDigits: 0}) + ' UZS';
                        }
                    });
                });
            }

            const printModalInstance = new bootstrap.Modal(document.getElementById('printChoiceModal'));
            const paymentBlocks = document.querySelectorAll('.payment-block');

            function showAllBlocks() {
                paymentBlocks.forEach(block => {
                    block.classList.remove('hide-for-print');
                });
            }

            document.getElementById('printVariant1Btn').addEventListener('click', () => {
                showAllBlocks();
                paymentBlocks.forEach(block => {
                    const typeKey = block.dataset.typeKey;
                    if (typeKey !== 'full_payment' && typeKey !== 'mortgage') {
                        block.classList.add('hide-for-print');
                    }
                });
                printModalInstance.hide();
                setTimeout(() => window.print(), 200);
            });

            document.getElementById('printComboBtn').addEventListener('click', () => {
                showAllBlocks();
                printModalInstance.hide();
                setTimeout(() => window.print(), 200);
            });

            window.onafterprint = showAllBlocks;
        });
    </script>
</body>
</html>