<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/commercial_offer_style.css') }}">
</head>

<body class="theme-jeweler" data-usd-rate="{{ usd_to_uzs_rate }}">
    <div class="page-container">

        <div class="no-print d-flex justify-content-end align-items-center mb-3 gap-3">
             <div class="me-auto">
                 <small class="text-muted">{{ _('Тема:') }}</small>
                 <strong id="current-theme-display"></strong>
             </div>

             <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="currency-switcher">
                <label class="form-check-label" for="currency-switcher">USD</label>
             </div>
             <button id="theme-switcher" class="btn btn-outline-secondary btn-sm">{{ _('Сменить тему') }}</button>
             <button class="btn btn-primary btn-sm" onclick="window.print()">{{ _('Печать') }}</button>
        </div>

        <div class="header">
            <div class="header-logo">
                <svg viewBox="0 0 66 18" xmlns="http://www.w3.org/2000/svg">
                    <path class="logo-accent" d="M0 0.142855V17.3983H12.3396V15.3682H1.98446V12.7743C2.78968 13.3808 3.78355 13.74 4.85744 13.74H8.6516V7.75762H4.81743V9.78767H6.66714V11.7099H4.85744C3.27314 11.7099 1.98446 10.3908 1.98446 8.77014C1.98446 7.14944 3.27314 5.83117 4.85744 5.83117H6.63692V3.80112H4.85744C3.78273 3.80112 2.78968 4.16034 1.98446 4.76685V2.1729H14.8835V7.75512H12.3396V3.80112H8.50624V5.83117H10.356V13.74H12.3404V9.786H14.8843V17.3983H16.8687V0.142855H0Z"/>
                    <path class="logo-main" d="M27.7768 17.3966H26.2227V14.8202H23.3824V17.3966H21.8283V10.8186H23.3824V13.5704H26.2227V10.8186H27.7768V17.3966ZM29.3112 14.1076C29.3112 12.2221 30.6081 10.6765 32.7404 10.6765C34.8726 10.6765 36.1907 12.2221 36.1907 14.1076C36.1907 15.9931 34.8939 17.5394 32.7404 17.5394C30.5869 17.5394 29.3112 15.9939 29.3112 14.1076ZM34.5835 14.1076C34.5835 12.9672 33.78 12.2112 32.7404 12.2112C31.7008 12.2112 30.9184 12.9672 30.9184 14.1076C30.9184 15.2479 31.722 16.004 32.7404 16.004C33.7587 16.004 34.5835 15.2479 34.5835 14.1076ZM37.7775 14.557V10.8186H39.3316V14.557C39.3316 15.3131 39.7921 16.004 40.7354 16.004C41.6786 16.004 42.1286 15.3248 42.1286 14.557V10.8186H43.6827V14.557C43.6827 16.2563 42.5786 17.5394 40.7354 17.5394C38.8922 17.5394 37.7775 16.2571 37.7775 14.557ZM46.2984 15.4451C46.2984 15.4451 47.231 16.0808 48.1734 16.0808C48.7631 16.0808 48.977 15.8285 48.977 15.5328C48.977 15.1928 48.7524 15.0173 47.7765 14.7433C46.3621 14.3382 45.5585 13.8001 45.5585 12.7149C45.5585 11.5203 46.3948 10.6757 48.1408 10.6757C49.8868 10.6757 50.6487 11.3775 50.6487 11.3775L49.8125 12.6707C49.8125 12.6707 49.1159 12.1226 48.1408 12.1226C47.5299 12.1226 47.3478 12.3307 47.3478 12.6047C47.3478 12.9338 47.6475 13.065 48.4625 13.2847C49.9733 13.6899 50.799 14.2605 50.799 15.3565C50.799 16.5512 49.9848 17.5386 48.2159 17.5386C46.447 17.5386 45.4507 16.6614 45.4507 16.6614L46.2976 15.4442L46.2984 15.4451ZM56.8651 14.7325H54.0354V16.0265H57.5935V17.3966H52.4813V10.8186H57.5935V12.1886H54.0354V13.4819H56.8651V14.7325ZM29.3112 3.43103C29.3112 1.54551 30.6081 0 32.7404 0C34.8726 0 36.1907 1.54551 36.1907 3.43103C36.1907 5.31655 34.8939 6.86206 32.7404 6.86206C30.5869 6.86206 29.3112 5.31655 29.3112 3.43103ZM34.5835 3.43103C34.5835 2.2907 33.78 1.53465 32.7404 1.53465C31.7008 1.53465 30.9184 2.29153 30.9184 3.43103C30.9184 4.57053 31.722 5.32741 32.7404 5.32741C33.7587 5.32741 34.5835 4.57137 34.5835 3.43103ZM37.7775 6.72004V0.14202H39.3316V5.34913H42.8105V6.71921L37.7775 6.72004ZM47.5454 6.72004H44.8766V0.14202H47.5454C49.6891 0.14202 50.9533 1.54551 50.9533 3.43103C50.9533 5.31655 49.6891 6.72004 47.5454 6.72004ZM46.4307 1.51293V5.34997H47.427C48.5418 5.34997 49.3453 4.70336 49.3453 3.43187C49.3453 2.16037 48.5418 1.51293 47.427 1.51293H46.4307ZM56.8651 4.05592H54.0354V5.34913H57.5935V6.71921H52.4813V0.14202H57.5935V1.51209H54.0354V2.80531H56.8651V4.05592ZM65.3321 6.72004H64.9785L60.8201 3.09102V6.72004H59.2766V0.14202H59.6302L63.7886 3.62819V0.153716H65.3321V6.72004ZM25.2329 1.51293H27.7833V0.14202H25.1145C22.9708 0.14202 21.7066 1.54551 21.7066 3.43103C21.7066 5.31655 22.9708 6.72004 25.1145 6.72004H27.7833V2.80614H24.9863V4.05592H26.2292V5.34913H25.2329C24.1182 5.34913 23.3146 4.70253 23.3146 3.43103C23.3146 2.15954 24.1182 1.51293 25.2329 1.51293Z"/>
                </svg>
            </div>
            <h1>{{ _('Коммерческое предложение') }}</h1>
            <p><strong>Golden House | {{ _('Жилая недвижимость') }}. {{ _('Дата') }}: {{ current_date }}</strong></p>
        </div>

        <div class="layout-wrapper">
            <div class="layout-main">
                <div class="section-title">1. {{ _('Информация об объекте') }}</div>
                <div class="info-block">
                    <div class="info-item"><span class="info-label">{{ _('Жилой комплекс:') }}</span><span class="info-value">{{ data.apartment.house.complex_name }}</span></div>
                    <div class="info-item"><span class="info-label">{{ _('Общая площадь:') }}</span><span class="info-value">{{ data.apartment.estate_area }} м²</span></div>
                    <div class="info-item">
                        <span class="info-label">{{ _('Прайс:') }}</span>
                        <span class="info-value price-value" data-uzs-value="{{ data.apartment.estate_price }}">{{ "{:,.0f}".format(data.apartment.estate_price)|replace(',', '.') }} UZS</span>
                    </div>
                </div>

                <div class="section-title">2. {{ _('Детализация расчета') }}</div>
                <div class="calc-details-card">
                    <div class="card-body">
                        {% if calc_type == 'standard_installment' %}
                            <h5 class="card-title text-primary">{{ _('Расчет по "Стандартной рассрочке"') }}</h5>
                            <p class="card-text">{% trans term=details.term_months %}Расчет произведен на срок <strong>{{ term }} мес.</strong>{% endtrans %}</p>
                            <hr>
                            <dl>
                                <dt>{{ _('Стоимость по прайсу (за вычетом 3 млн):') }}</dt>
                                <dd><span class="price-value" data-uzs-value="{{ details.price_list - 3000000 }}">{{ "{:,.0f}".format(details.price_list - 3000000)|replace(',', '.') }} UZS</span></dd>
                                <dt>{{ _('Расчетная скидка:') }}</dt>
                                <dd class="price-decrease">{{ "%.0f"|format(details.calculated_discount) }} %</dd>
                                <dt class="result-row">{{ _('Итоговая стоимость договора:') }}</dt>
                                <dd class="result-row price-final"><span class="price-value" data-uzs-value="{{ details.calculated_contract_value }}">{{ "{:,.0f}".format(details.calculated_contract_value)|replace(',', '.') }} UZS</span></dd>
                                <dt class="result-row border-top pt-2 mt-2">{{ _('Ежемесячный платеж:') }}</dt>
                                <dd class="result-row border-top pt-2 mt-2 fw-bold"><span class="price-value" data-uzs-value="{{ details.monthly_payment }}">{{ "{:,.0f}".format(details.monthly_payment)|replace(',', '.') }} UZS</span></dd>
                            </dl>
                        {% elif calc_type == 'dp_installment' %}
                            <h5 class="card-title text-primary">{{ _('Расчет по "Рассрочке на ПВ + Ипотека"') }}</h5>
                            <p class="card-text">{% trans term=details.term_months %}Рассрочка на первоначальный взнос оформлена на срок <strong>{{ term }} мес.</strong>{% endtrans %}</p>
                            <hr>
                            <dl>
                                <dt>{{ _('Ежемесячный платеж по ПВ:') }}</dt>
                                <dd><span class="price-value" data-uzs-value="{{ details.monthly_payment_for_dp }}">{{ "{:,.0f}".format(details.monthly_payment_for_dp)|replace(',', '.') }} UZS</span></dd>
                                <dt>{{ _('Тело ипотеки (остаток долга):') }}</dt>
                                <dd><span class="price-value" data-uzs-value="{{ details.mortgage_body }}">{{ "{:,.0f}".format(details.mortgage_body)|replace(',', '.') }} UZS</span></dd>
                                <dt class="result-row border-top pt-2 mt-2">{{ _('Итоговая стоимость договора:') }}</dt>
                                <dd class="result-row price-final"><span class="price-value" data-uzs-value="{{ details.calculated_contract_value }}">{{ "{:,.0f}".format(details.calculated_contract_value)|replace(',', '.') }} UZS</span></dd>
                            </dl>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="layout-sidebar">
                {% if details.payment_schedule %}
                <div class="section-title">3. {{ _('График платежей') }}</div>
                <table class="table table-sm payment-schedule-table">
                    <thead><tr><th scope="col">№</th><th scope="col">{{ _('Дата платежа') }}</th><th scope="col">{{ _('Описание') }}</th><th scope="col" class="text-end">{{ _('Сумма') }}</th></tr></thead>
                    <tbody>
                        {% for payment in details.payment_schedule %}
                        <tr>
                            <td>{{ payment.month_number }}</td>
                            <td>{{ payment.payment_date.strftime('%d.%m.%Y') }}</td>
                            <td>{% if payment.type == 'monthly_payment' %} {{ _('Ежемесячный платеж по рассрочке') }} {% elif payment.type == 'dp_payment' %} {{ _('Платеж по рассрочке на ПВ') }} {% elif payment.type == 'mortgage_body' %} <strong class="text-primary">{{ _('Ипотечный кредит (оформляется в банке)') }}</strong> {% endif %}</td>
                            <td class="text-end fw-bold"><span class="price-value" data-uzs-value="{{ payment.amount }}">{{ "{:,.0f}".format(payment.amount)|replace(',', '.') }}</span> <span class="currency-symbol">UZS</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% endif %}
            </div>
        </div>

        <div class="footer">
            <p>{% trans %}Это коммерческое предложение не является публичной офертой. Актуальность цен и условий уточняйте у менеджеров Golden House.{% endtrans %}</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- ЛОГИКА ПЕРЕКЛЮЧАТЕЛЯ ТЕМ ---
            const themeSwitcher = document.getElementById('theme-switcher');
            const themeDisplay = document.getElementById('current-theme-display');
            const body = document.body;
            const themes = [ { class: 'theme-jeweler', name: '{{ _("Ювелир") }}' }, { class: 'theme-architect', name: '{{ _("Архитектор") }}' }, { class: 'theme-parchment', name: '{{ _("Парчмент") }}' }, { class: 'theme-gallery', name: '{{ _("Галерея") }}' }, { class: 'theme-infographic', name: '{{ _("Инфографика") }}' } ];
            let currentThemeIndex = themes.findIndex(theme => body.classList.contains(theme.class));
            if (currentThemeIndex === -1) { currentThemeIndex = 0; body.classList.add(themes[0].class); }
            function updateThemeDisplay() { if(themeDisplay) { themeDisplay.textContent = themes[currentThemeIndex].name; } }
            if(themeSwitcher) {
                themeSwitcher.addEventListener('click', function() {
                    currentThemeIndex = (currentThemeIndex + 1) % themes.length;
                    body.className = '';
                    body.classList.add(themes[currentThemeIndex].class);
                    updateThemeDisplay();
                });
            }
            updateThemeDisplay();

            // --- НАЧАЛО: НОВАЯ ЛОГИКА ПЕРЕКЛЮЧАТЕЛЯ ВАЛЮТ ---
            const currencySwitcher = document.getElementById('currency-switcher');
            const usdRate = parseFloat(document.body.dataset.usdRate);

            function formatNumberWithDots(num) {
                return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            }

            function updatePrices() {
                const isUsd = currencySwitcher.checked;
                document.querySelectorAll('.price-value').forEach(el => {
                    const uzsValue = parseFloat(el.dataset.uzsValue);
                    if (isNaN(uzsValue)) return;

                    let displayValue;
                    let symbol = isUsd ? '$' : 'UZS';

                    if (isUsd) {
                        displayValue = formatNumberWithDots(uzsValue / usdRate);
                        // Для элементов с символом валюты снаружи
                        if (el.nextElementSibling && el.nextElementSibling.classList.contains('currency-symbol')) {
                           el.nextElementSibling.textContent = ''; // Убираем UZS
                           el.textContent = '$' + displayValue;
                        } else {
                           el.textContent = '$' + displayValue;
                        }
                    } else {
                        displayValue = formatNumberWithDots(uzsValue);
                         if (el.nextElementSibling && el.nextElementSibling.classList.contains('currency-symbol')) {
                           el.nextElementSibling.textContent = 'UZS';
                           el.textContent = displayValue;
                        } else {
                           el.textContent = displayValue + ' UZS';
                        }
                    }
                });
                // Обновляем заголовок в таблице
                const tableHeader = document.querySelector('.payment-schedule-table th:last-child');
                if (tableHeader) {
                    tableHeader.textContent = isUsd ? '{{ _("Сумма ($)") }}' : '{{ _("Сумма (UZS)") }}';
                }
            }

            if (currencySwitcher && !isNaN(usdRate)) {
                currencySwitcher.addEventListener('change', updatePrices);
                // Инициализируем при загрузке
                updatePrices();
            }
        });
    </script>
</body>
</html>